name: Build Desktop App (Windows & Linux)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Prepare backend
        working-directory: backend
        run: |
          if (Test-Path staticfiles) { Remove-Item -Recurse -Force staticfiles }
          Copy-Item -Recurse ../frontend/dist staticfiles
          if (-not (Test-Path templates)) { New-Item -ItemType Directory -Path templates }
          (Get-Content ../frontend/dist/index.html) `
            -replace 'href="/assets/', 'href="/static/assets/' `
            -replace 'src="/assets/', 'src="/static/assets/' `
            | Set-Content templates/index.html

      - name: Build Windows executable
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          python manage.py migrate --noinput
          pyinstaller marmitaria_desktop.spec --clean --noconfirm
        env:
          SECRET_KEY: django-insecure-build-key

      - name: Verify Windows executable
        working-directory: backend
        run: |
          if (Test-Path dist\Marmitaria.exe) {
            $file = Get-Item dist\Marmitaria.exe
            Write-Host "✓ Executável criado: $($file.Name) ($([math]::Round($file.Length / 1MB, 2)) MB)"
          } else {
            Write-Host "✗ ERRO: Executável não encontrado!"
            exit 1
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: backend/dist/Marmitaria.exe

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-sync1 \
            libxcb-xfixes0 \
            libxcb-xkb1 \
            libxkbcommon-x11-0 \
            libxkbcommon0

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Prepare backend
        working-directory: backend
        run: |
          rm -rf staticfiles
          cp -r ../frontend/dist staticfiles
          mkdir -p templates
          sed 's|href="/assets/|href="/static/assets/|g; s|src="/assets/|src="/static/assets/|g' \
            ../frontend/dist/index.html > templates/index.html

      - name: Build Linux executable
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          python manage.py migrate --noinput
          pyinstaller marmitaria_desktop_onedir.spec --clean --noconfirm
          chmod +x dist/Marmitaria/Marmitaria
        env:
          SECRET_KEY: django-insecure-build-key

      - name: Verify Linux executable
        working-directory: backend
        run: |
          if [ -f "dist/Marmitaria/Marmitaria" ]; then
            echo "✓ Executável criado: $(ls -lh dist/Marmitaria/Marmitaria | awk '{print $5, $9}')"
            test -x dist/Marmitaria/Marmitaria || (echo "✗ Erro: sem permissão de execução" && exit 1)
          else
            echo "✗ ERRO: Executável não encontrado!"
            exit 1
          fi

      - name: Create tarball
        working-directory: backend/dist
        run: |
          tar -czf marmitaria-linux.tar.gz Marmitaria/
          echo "✓ Tarball criado: $(ls -lh marmitaria-linux.tar.gz | awk '{print $5, $9}')"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tar
          path: backend/dist/marmitaria-linux.tar.gz

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify artifacts
        run: |
          echo "Verificando artefatos baixados..."
          ls -R artifacts/ || true
          if [ ! -f "artifacts/windows-exe/Marmitaria.exe" ]; then
            echo "✗ ERRO: Marmitaria.exe não encontrado!"
            exit 1
          fi
          if [ ! -f "artifacts/linux-tar/marmitaria-linux.tar.gz" ]; then
            echo "✗ ERRO: marmitaria-linux.tar.gz não encontrado!"
            exit 1
          fi
          echo "✓ Todos os artefatos encontrados!"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            artifacts/windows-exe/Marmitaria.exe
            artifacts/linux-tar/marmitaria-linux.tar.gz
